<html>
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
<style>
#map {
      width: 800px;
      height: 500px;
    }
.info {
      padding: 6px 8px;
      font: 14px/16px Arial, Helvetica, sans-serif;
      background: white;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
    }

    .desc {
          padding: 8px 8xfpx;
          font: 14px/16px Arial, Helvetica, sans-serif;
          background: white;
          background: rgba(255, 255, 255, 0.8);
          box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
          border-radius: 5px;
          width: 98%;
        }

    .distribution {
      padding: 6px 8px;
      font: 14px/16px Arial, Helvetica, sans-serif;
      background: white;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      float: left;
      text-align: left;
    }
    .info h4 {
      margin: 0 0 5px;
      color: #777;
    }
    .legend {
      text-align: left;
      line-height: 18px;
      color: #555;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
    .filter {
      text-align: left;
      padding: 6px 8px;
      font: 14px/16px Arial, Helvetica, sans-serif;
      background: white;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
    }
</style>
</head>
<body>
<div id="map" > </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script src="puma-data.js" > </script>
  <script src="county-data.js" > </script>



  <script>

    var infoSentece = null;
    var county_abbr = {
    "alameda": "a",
    "napa": "n",
    "santa clara": "sc",
    "contra costa": "cc",
    "san francisco": "sf",
    "solano": "so",
    "marin": "ma",
    "san mateo": "sm",
    "sonoma": "so",
    "sf": "sf",
    "cc": "cc",
    "sm": "sm",
    "sc": "sc"
    }
    var county_current = "";
    function selecteDataSet(county_name) {
      county_name = county_name.toLowerCase();
      county_current = county_name;
      //if (document.getElementById("income").value != "all" && document.getElementById("race").value != "all") {
        infoSentece = createInfoSentence(document.getElementById("income").value, document.getElementById("race").value, county_name);
        return county_abbr[county_name] + "_" + document.getElementById("income").value + "_" + document.getElementById("race").value
      //}

    }
    var dataset_forcolor = "";
    function displayDataSet(dataset) {
      console.log(dataset);
      generateCutoffs(dataset);
      dataset_forcolor = dataset;
      window.map.removeLayer(geojson);
      geojson = L.geoJson(pumaData, {
        style: style,
        onEachFeature: onEachFeature
      }).addTo(map);
    }

    function updateDataset() {
      var dataset = selecteDataSet(selectedLayer.feature.properties.county);
      displayDataSet(dataset);
      //legend.update(map);
      legend.addTo(map);
    }

    function toTitleCase(str) {
        return str.replace(/\w\S*/g, function(txt){
            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
        });
    }
    var county_outline = null;
    function createCountyOutline() {
      county_cap = toTitleCase(county_current)
      for (i in county_data["features"]) {
        if (county_cap == county_data["features"][i]["properties"]["county"]) {
          //county_outline = county_data["features"][i]["geometry"]["coordinates"];
          county_outline = new L.Polygon(county_data["features"][i]["geometry"]["coordinates"]).addTo(map);
          county_outline.setStyle(style2);
        }
      }



      //county_outline.addTo(map);
    }

    function createInfoSentence(income, race, county) {
    county = toTitleCase(county);
    var income_abbr = {
        "el": "Extremely Low", //[<30% AMI]
        "vl": "Very Low", //[<50% AMI]
        "li": "Low", //[50%-80% AMI]
        "lw": "Low", // [<80% AMI]
        "m": "Middle", //[80%-120% AMI]
        "h": "High", //[>120% AMI]
        "z": "All"
    }
    i = income;
    income = income_abbr[income];
    var race_abbr = {
        "wht": "White",
        "hsp": "Latinx",
        "blk": "Black",
        "api": "Asian-Pacific Islander",
        "poc": "People Of Color",
        "z": "All"
    }
    r = race;
    race = race_abbr[race]
      if (i == "z" && r == "z") {
          return "All people who moved from " + county + " County to:";
      } else if (i == "z") {
          return "All "+ race +" who moved from " + county + " County to:";
      } else if (r == "z") {
          return "All "+ income +" Income who moved from " + county + " County to:";
      } else {
          return income +" Income "+ race +" who moved from " + county + " County to:";
      }
    }

    function resetCounty() {
      window.map.removeLayer(geojson);
      map.removeControl(stateDistribution);
      map.removeControl(legend);
      //map.removeControl(info);

      //legend.removeLayer(map);
      selectedLayer = null;
      infoSentece = null;
      geojson = L.geoJson(county_data, {
        style: style,
        onEachFeature: onEachFeature
      }).addTo(map);
      info.addTo(map);
      //info.addTo(desc);
    }

    var colorCutoffs = [];
    function generateCutoffs(dataset){
      arr = [];
      for (i in pumaData["features"]) {
          arr.push(parseInt(pumaData["features"][i]["properties"][dataset]))
      }
      range = Math.max(...arr) - 0; //Math.min(arr);
      bucket_width = parseInt(range / 7);
      var curr = 0;
      cutoffs = [0]
      for (var i = 1; i < 8; i++) {
        cutoffs.push(curr);
        curr = curr + bucket_width;
      }
      //return cutoffs;
      console.log(cutoffs);
      colorCutoffs = cutoffs;
      //colorCutoffs = [0, 200, 400, 600, 800, 1000, 1200, 1600];
    }

    var map = L.map("map").setView([37.8735, -122.4566], 8);
    //37.8735° N, 122.4566  37.7749, -122.4194
    /*
    L.tileLayer(
      "https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw",
      {
        maxZoom: 18,
        attribution:
          'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>' +
          'Imagery © <a href="http://mapbox.com">Carto</a>',
        id: "mapbox.light"
      }
    ).addTo(map);*/
    map.createPane('labels');
    map.getPane('labels').style.zIndex = 650;
    map.getPane('labels').style.pointerEvents = 'none';

    var positron = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', {
            //attribution: '©OpenStreetMap, ©CartoDB'
    }).addTo(map);

    var positronLabels = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', {
            attribution: '©OpenStreetMap, ©CartoDB, Dataset <a href="https://usa.ipums.org/usa/"> IPUMS </a>',
            pane: 'labels'
    }).addTo(map);

    // control that shows state info on hover
    var info = L.control();
    info.onAdd = function(map) {
      this._div = L.DomUtil.create("div", "info");
      this.update();
      return this._div;
    };
    info.update = function(props) {
      if (selectedLayer && infoSentece) {
      this._div.innerHTML =
        //"<h4># of people that were moved from SF</h4>" +
        "<b>" + infoSentece + "</b>" + "<br>" +
        (props
          ? /*"<b>"*/
            props.NAME10 +
            /*"</b>*/"<br />" +
            props[dataset_forcolor] +
            " people"
          : "Hover over a state");
      } else {
        this._div.innerHTML =
          (props
            ? "<b>" +
              props.county +
              " County"
            : "Hover over a county");
      }
    };
    info.addTo(map);
    // =============================================
    // SHOWS DESCRIPTION OF DATASET BEFORE CLICKING ON A COUNTY
    // =============================================
    //var desc = L.control({ position: "bottomright" });
    var desc = L.control();
    desc.onAdd = function(map) {
      this._div = L.DomUtil.create("div", "desc");
      this.update();
      return this._div;
    };
    desc.update = function() {
      this._div.innerHTML =
        //"<h4># of people that were moved from SF</h4>" +
        "Descrition of the Dataset" + "<br>" +
        `This migration data shows people who moved in 2015. Start by clicking
        on the county of origin, then select the race and income group of interest.
        The map will show where movers from this county went (within Northern California),
        as well as provide data on people who left the region and state. This
        data comes from the ACS 1-year Public Use Microdata Sample (PUMS) for 2015` + "<br>" +
        "Created by Community Center for Innovation at UC Berkeley."
        + "<br>" +
         "<button onclick='closeDesc()'>Close</button>";
    };
    desc.addTo(map);
    function closeDesc() {
        map.removeControl(desc);
    }
    function showDesc() {
      desc.addTo(map);
    }
    // =============================================
    // SHOWS INSTATE / OUT OF STATE DISTRIBUTION
    // =============================================
    var stateDistribution = L.control({ position: "bottomleft" });
    stateDistribution.onAdd = function(map) {
      this._div = L.DomUtil.create("div", "distribution");
      this.click();
      return this._div;
    };
    stateDistribution.click = function(props) {
      //if (selectedLayer != null) {
      this._div.innerHTML =
        "<b>" + "# of people from " + toTitleCase(county_current) + " County who moved:<br> </b>" +
        "Out of Region: NA" + "<br>" +
        "Out of State: NA";

    };

    // MY CODE
    // ADD PART TO MAP THAT ALLOWS USER TO FILTER THE INFORMATION
    // control that shows state info on hover
    var filter = L.control({position: 'bottomleft'});
    filter.onAdd = function(map) {
      this._div = L.DomUtil.create("div", "filter");
      this.onNewCounty();
      return this._div;
    };
    filter.onNewCounty = function(props) {
      this._div.innerHTML =
  `
  <button onclick="resetCounty()">Choose new county</button>

  <br>
  <select id="race" onchange="updateDataset()">
  <option value='z'>All</option>
  <option value='api'>Asian-Pacific Islander</option>
  <option value='blk'>Black</option>
  <option value='hsp'>Latinx</option>
  <option value='poc'>All People of Color</option>
  <option value='wht'>White</option>
  </select>
  <br>
  <select id="income" onchange="updateDataset()">
  <option value='z'>All</option>
  <option value='h'>High [>120% AMI]</option>
  <option value='m'>Middle [80%-120% AMI]</option>
  <option value='lw'>Low [<80% AMI]</option>

  <option value='vl'>Very Low [<50% AMI]</option>
  <option value='el'>Extremley Low [<30% AMI]</option>
  </select>
  <br>
  <button onclick='showDesc()'>Info</button>
  `
  //<option value='li'>Low [50%-80% AMI]</option>
    };
    filter.addTo(map);


    // get color depending on population density value
    function getColor(d) {
      var grades = [0, 200, 400, 600, 800, 1000, 1200, 1600];
      //5a001b
      return d > grades[7]
        ? "#5a001b"
        : d > grades[6]
        ? "#800026"
        : d > grades[5]
        ? "#BD0026"
        : d > grades[4]
        ? "#E31A1C"
        : d > grades[3]
        ? "#FC4E2A"
        : d > grades[2]
        ? "#FD8D3C"
        : d > grades[1] ? "#FEB24C"
        //: d > colorCutoffs[1] ? "#FED976"
        : d > grades[0] + 1 ? "#FED976"
        : "#ffedc8"; // #FFEDA0
    }
    function style(feature) {
      return {
        weight: 2,
        opacity: 1,
        color: "white",
        dashArray: "3",
        fillOpacity: 0.7,
        fillColor: getColor(feature.properties[dataset_forcolor])//feature.properties.sf_li_all
      };
    }
    function style2() {
      return {
        weight: 2,
        opacity: 1,
        color: "black",
        dashArray: "1",
        fillOpacity: 0,
        fillColor: black//feature.properties.sf_li_all
      };
    }
    //THE CODE THAT I AM WRITING TO HAVE YOU BE
    // ABLE TO SELECT A STATE AND THEN SEE THE DISPALCEMENT
    // AMOUNTS OF OTHER PUMAS
    function viewData(e) {
      var layer = e.target;
      layer.setStyle({
        weight: 5,
        color: "#666",
        dashArray: "",
        fillOpacity: 0.7
      });

      if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        layer.bringToFront();
      }
      info.update(layer.feature.properties);
    }

    var selectedLayer = null;
    function selectState(e) {
      selectedLayer = e.target;
      console.log(e.target.feature.properties.county);
      var dataset = selecteDataSet(e.target.feature.properties.county);
      displayDataSet(dataset);
      createCountyOutline();
      //legend.update(map);
      stateDistribution.addTo(map);
      stateDistribution.click(dataset);
      map.removeControl(desc);
      info.addTo(map);
      legend.addTo(map);
    }


    function resetHighlight(e) {
      geojson.resetStyle(e.target);
      info.update();
      /*
      if (e.target != lastclick) {
      geojson.resetStyle(e.target);
      if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        //selectedLayer.bringToFront();
      }
      info.update(selectedLayer.feature.properties);
    }*/
    }

    // BACK TO NORMAL CODE
    function onEachFeature(feature, layer) {
      layer.on({
        mouseover: viewData,
        mouseout: resetHighlight,
        click: selectState
      });
      /*layer.on('click', function(e){
          if(lastclick) {
               geojson.resetStyle(e.target);
               info.update();
             }
          lastclick = e.target;
     });*/
    }

    //USE county_data or pumaData or county_data
    geojson = L.geoJson(county_data, {
      style: style,
      onEachFeature: onEachFeature
    }).addTo(map);

/*    map.attributionControl.addAttribution(
      'Population data &copy; <a href="http://census.gov/">US Census Bureau</a>'
    );*/
    var legend = L.control({ position: "bottomright" });
    legend.onAdd = function(map) {
      var div = L.DomUtil.create("div", "info legend"),
        //grades = [0, 10, 20, 50, 100, 200, 500, 1000],
        grades = [0, 1, 200, 400, 600, 800, 1000, 1200, 1600], //colorCutoffs
        //grades = colorCutoffs,
        labels = [],
        from = 0,
        to = 0;
        labels.push(
          '<i style="background:' +
            getColor(from + 1) +
            '"></i> ' +
            from
        );
      for (var i = 1; i < grades.length; i++) {
        from = grades[i];
        to = grades[i + 1];
        if (from == 0) {
          labels.push(
            '<i style="background:' +
              getColor(from + 2) +
              '"></i> ' +
              parseInt(from + 1) +
              (to ? "&ndash;" + to : "+")
          );
        } else {
          labels.push(
            '<i style="background:' +
              getColor(from + 1) +
              '"></i> ' +
              from +
              (to ? "&ndash;" + to : "+")
          );
        }

      }
      div.innerHTML = "<p style='font-size:10px; padding: 0; margin: 0;'> # of people who moved: </p> " + labels.join("<br>");
      return div;

    };
    //legend.addTo(map);
  </script>
</body>
</html>
